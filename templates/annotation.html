<!DOCTYPE html>
<html>
<head>
<title>Test Title</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</head>
<body>



<div class="container">
    <h1>dataset: {{dataset}}</h1>
    <h2 id="imageName">{{images[0]}}</h2>
    <p id="coords" > (x,y)</p>

    <div class="row ">
        <div class="col"> 
            <button type="button" class="btn btn-secondary">Back</button>
            <button type="button" class="btn btn-primary">Next</button> 
        </div>
        <div class="col"> 
            <button id="reloadButton" type="button" class="btn btn-info">Reload annotation image</button>
        </div>
    </div>
    <div class="row ">
        <div class="col">
            <img id="originalImage" src="{{ url_for('static', path='dataset/'+ dataset +'/' + images[0]) }}" width="100%" class="" alt="...">
        </div>
        <div class="col">
            <img id="annotatoImage" src="https://dummyimage.com/1600x400/000/fff"  width="100%"  class=" " alt="...">
        </div>
    </div>  

    <div class="row ">
        <h2>total annotation image</h2>
        <div class="col"> 
            <button type="button" class="btn btn-primary">show</button>
        </div>
    </div>
    <div class="row">
        <img id="" src="https://dummyimage.com/1600x400/000/fff"  width="100%"  class=" " alt="...">
    </div>

</div>

<script>
    const image = document.getElementById("originalImage");
    const coords = document.getElementById("coords");
    const annotatoImage = document.getElementById("annotatoImage");

    const images = {{ images | tojson }};
    const datasetUrl = "{{ url_for('static', path='dataset/'+ dataset+'/' ) }}";
    console.log("{{ url_for('static', path='dataset/'+ dataset+'/' ) }}");

    const shownImageIndex = 0;

    image.addEventListener('load', function() {
        // 画像の自然サイズを取得
        const naturalWidth = image.naturalWidth;
        const naturalHeight = image.naturalHeight;
        
        
        image.addEventListener('click', function(event) {
            console.log(image);
            // 画像の表示サイズを取得
            const rect = image.getBoundingClientRect();
            const displayedWidth = rect.width;
            const displayedHeight = rect.height;

            // クリック位置のページ座標を取得
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;

            // スケーリングファクターを計算
            const scaleX = naturalWidth / displayedWidth;
            const scaleY = naturalHeight / displayedHeight;

            // オリジナル座標を計算
            const originalX = Math.round(clickX * scaleX);
            const originalY = Math.round(clickY * scaleY);
            coords.textContent = `(${originalX},${originalY})`;

            // 座標データをサーバーに送信
            fetch('/post_coordinates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    fn: images[shownImageIndex],
                    dataset: "{{dataset}}",
                    x: originalX,
                    y: originalY
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                annotatoImage.src = "{{ url_for('static', path='tmp_annotato/' ) }}" + data.annotato_path;

            })
            .catch((error) => {
                console.error('Error:', error);
            });

        });
    });



    //reload button
    const reloadButton = document.getElementById('reloadButton');
    // ボタンクリック時のイベントリスナーを追加
    reloadButton.addEventListener('click', function() {
        // 画像のソースURLにタイムスタンプを追加してキャッシュを回避
        const timestamp = new Date().getTime();
        const originalSrc = annotatoImage.getAttribute('src').split('?')[0];
        annotatoImage.setAttribute('src', `${originalSrc}?t=${timestamp}`);
    });
</script>

</body>

</html>