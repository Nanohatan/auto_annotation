<!DOCTYPE html>
<html>
<head>
<title>Test Title</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<style>
    .marker {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: red;
        border-radius: 50%;
        pointer-events: none; /* マーカー自体はクリックできないように */
    }
</style>
</head>
<body>

<div class="container">
    <h1>dataset: {{dataset}}</h1>
    <h2 id="imageName">{{images[0]}}, </h2>
    <i id="progress"></i>
    <p id="coords" > (x,y)</p>

    <div class="row m-2">
        <div class="col"> 
            <button id="backButton" type="button" class="btn btn-outline-secondary">Back</button>
            <button  id="nextButton" type="button" class="btn btn-outline-primary">Next</button> 
            <button id="clearMarkers" type="button" class="btn btn-outline-secondary">Clear Markers</button>
            
        </div>
        <div class="col"> 
            <button id="reloadButton" type="button" class="btn btn-info">Reload annotation image</button>
            <button id="saveButton" type="button" class="btn btn-primary">Save</button>
        </div>
    </div>
    <div class="row m-2">
        <div class="col"> 
            <button id="positiveButton" type="button"  class="btn btn-outline-secondary active">positive</button>
            <button id="multiButton" type="button" class="btn btn-outline-secondary">Multi</button>
            <button id="negativeButton"  type="button" class="btn btn-outline-secondary">negative</button>
            <button id="submitButton" type="button" class="btn btn-outline-primary">Submit</button>
        </div>
    </div>
    <div class="row">
        <div class="col"  >
            <div style="position: relative;" id="imageContainer"><img id="originalImage" src="{{ url_for('static', path='dataset/'+ dataset +'/' + images[0]) }}" width="100%" class="" alt="..."></div>
            
        </div>
        <div class="col">
            <img id="annotatoImage" src="{{ url_for('static', path='dataset/'+ dataset +'/' + images[0]) }}" width="100%"  class=" " alt="...">
        </div>
    </div>  

    <div class="row m-2">
        <h2>total annotation image</h2>
        <div class="col"> 
            <button id="showResultButton" type="button" class="btn btn-primary">show</button>
            <button id="reloadResultImagButton" type="button" class="btn btn-info">Reload result image</button>
        </div>
    </div>
    <div class="row">
        <img id="annotatoResultImage" src="{{ url_for('static', path='dataset/'+ dataset +'/' + images[0]) }}" width="100%"  class=" " alt="...">
    </div>

</div>

<script>
    const coords = document.getElementById("coords");
    const image = document.getElementById("originalImage");
    const annotatoImage = document.getElementById("annotatoImage");
    const imageName = document.getElementById("imageName");
    const progress = document.getElementById("progress");
    const annotatoResultImage = document.getElementById("annotatoResultImage");
    const multiButton = document.getElementById("multiButton");
    const submitButton = document.getElementById("submitButton");

    multiButton.addEventListener("click", function() {
        this.classList.toggle("active");
    });
    let now_label = 1;
    let points = [];
    let labels = [];
    // negativeButtonがクリックされたら、positiveButtonのactiveを削除
    negativeButton.addEventListener("click", function() {
        this.classList.toggle("active");
        if (this.classList.contains("active")) {
            positiveButton.classList.remove("active");
            now_label = 0
        }
    });
    // positiveButtonがクリックされたら、negativeButtonのactiveを削除
    positiveButton.addEventListener("click", function() {
        this.classList.toggle("active");
        if (this.classList.contains("active")) {
            negativeButton.classList.remove("active");
            now_label = 1
        }
    });

    const images = {{ images | tojson }};

    const datasetUrl = "{{ url_for('static', path='dataset/'+ dataset+'/' ) }}";
    console.log("{{ url_for('static', path='dataset/'+ dataset+'/' ) }}");
    let shownImageIndex = 0;
    const nextButton = document.getElementById("nextButton");
    progress.textContent = `${shownImageIndex}/${images.length}`;
    nextButton.addEventListener("click", function() {
        shownImageIndex += 1;
        image.src = "{{ url_for('static', path='dataset/'+ dataset +'/') }}"+images[shownImageIndex];
        annotatoImage.src = "{{ url_for('static', path='dataset/'+ dataset +'/') }}"+images[shownImageIndex];
        annotatoResultImage.src = "{{ url_for('static', path='dataset/'+ dataset +'/') }}"+images[shownImageIndex];
        imageName.textContent = images[shownImageIndex];
        progress.textContent = `${shownImageIndex}/${images.length}`;

    });
    const backButton = document.getElementById("backButton");
    progress.textContent = `${shownImageIndex}/${images.length}`;
    backButton.addEventListener("click", function() {
        if (shownImageIndex>0){
            shownImageIndex += -1;
            image.src = "{{ url_for('static', path='dataset/'+ dataset +'/') }}"+images[shownImageIndex];
            annotatoImage.src = "{{ url_for('static', path='dataset/'+ dataset +'/') }}"+images[shownImageIndex];
            annotatoResultImage.src = "{{ url_for('static', path='dataset/'+ dataset +'/') }}"+images[shownImageIndex];
            imageName.textContent = images[shownImageIndex];
            progress.textContent = `${shownImageIndex}/${images.length}`;
        }


    });



    image.addEventListener('load', function() {
        // 画像の自然サイズを取得
        const naturalWidth = image.naturalWidth;
        const naturalHeight = image.naturalHeight;
        
        
        image.addEventListener('click', function(event) {
            console.log(image);
            // 画像の表示サイズを取得
            const rect = image.getBoundingClientRect();
            const displayedWidth = rect.width;
            const displayedHeight = rect.height;

            // クリック位置のページ座標を取得
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;

            // スケーリングファクターを計算
            const scaleX = naturalWidth / displayedWidth;
            const scaleY = naturalHeight / displayedHeight;

            // オリジナル座標を計算
            const originalX = Math.round(clickX * scaleX);
            const originalY = Math.round(clickY * scaleY);
            
            if (multiButton.classList.contains('active')) {
                points.push([originalX,originalY])
                labels.push(now_label);
                console.log(points,labels);
                coords.textContent = `${coords.textContent},(${originalX},${originalY})`;
            }else{
            coords.textContent = `[${originalX},${originalY}]`;
            points.length = 0;
            labels.length = 0;
            
            // 座標データをサーバーに送信
            fetch('/post_coordinates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    fn: images[shownImageIndex],
                    dataset: "{{dataset}}",
                    x: originalX,
                    y: originalY
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                annotatoImage.src = "{{ url_for('static', path='tmp_annotato/' ) }}" + data.annotato_path;

            })
            .catch((error) => {
                console.error('Error:', error);
            });
            }

        });
    });
    submitButton.addEventListener('click', function() {
        fetch('/post_input_point', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                fn: images[shownImageIndex],
                dataset: "{{dataset}}",
                point: points,
                label: labels
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
            annotatoImage.src = "{{ url_for('static', path='tmp_annotato/' ) }}" + data.annotato_path;

        })
        .catch((error) => {
            console.error('Error:', error);
        });
    });



    //reload button
    const reloadButton = document.getElementById('reloadButton');
    // ボタンクリック時のイベントリスナーを追加
    reloadButton.addEventListener('click', function() {
        // 画像のソースURLにタイムスタンプを追加してキャッシュを回避
        const timestamp = new Date().getTime();
        const originalSrc = annotatoImage.getAttribute('src').split('?')[0];
        annotatoImage.setAttribute('src', `${originalSrc}?t=${timestamp}`);
    });

    const reloadResultImagButton = document.getElementById('reloadResultImagButton');
    reloadResultImagButton.addEventListener('click', function() {
        // 画像のソースURLにタイムスタンプを追加してキャッシュを回避
        const timestamp = new Date().getTime();
        const originalSrc = annotatoResultImage.getAttribute('src').split('?')[0];
        annotatoResultImage.setAttribute('src', `${originalSrc}?t=${timestamp}`);
    });

    //save button
    const saveButton = document.getElementById('saveButton');
    // ボタンクリック時のイベントリスナーを追加
    saveButton.addEventListener('click', function() {
        fetch('/save_annotation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                fn: images[shownImageIndex],
                dataset: "{{dataset}}",
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data.image_path);
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    });

    //show result button
    const showResultButton = document.getElementById('showResultButton');
    
    // ボタンクリック時のイベントリスナーを追加
    showResultButton.addEventListener('click', function() {
        fetch('/annotation_result', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                fn: images[shownImageIndex],
                dataset: "{{dataset}}",
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
            annotatoResultImage.src = "{{ url_for('static', path='/' ) }}" + data.image_path;
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    });

    const imageContainer = document.getElementById('imageContainer');
    const clearButton = document.getElementById('clearMarkers');
    clearButton.addEventListener('click', function() {
        const markers = document.querySelectorAll('.marker');
        markers.forEach(marker => marker.remove());  // すべてのマーカーを削除
        points.length = 0;
        labels.length = 0;
        coords.textContent = "(x,y)";

    });
    image.addEventListener('load', function() {
        // 画像の自然サイズを取得
        const naturalWidth = image.naturalWidth;
        const naturalHeight = image.naturalHeight;
        
        // 画像をクリックしたときにマーカーを置く処理
        image.addEventListener('click', function(event) {
            // クリック位置を取得（画像内の相対座標）
            const rect = image.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // マーカーを作成して画像内に追加
            const marker = document.createElement('div');
            marker.classList.add('marker');
            marker.style.left = `${x - 5}px`;  // 中心を合わせるためにマーカーサイズの半分を引く
            marker.style.top = `${y - 5}px`;
            imageContainer.appendChild(marker);
        });
    });
</script>

</body>

</html>